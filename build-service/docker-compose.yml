version: '3.8'

services:
  build-service:
    build: .
    container_name: iocast-build-service
    restart: unless-stopped
    volumes:
      # Docker socket for running builds
      - /var/run/docker.sock:/var/run/docker.sock
      # Build cache - MUST be a host path for Docker-in-Docker to work
      # Both this container and the Android build container need to access it
      - /opt/iocast-build-service/build-cache:/app/cache
      # Local releases storage
      - ./releases:/app/releases
    environment:
      # MQTT Configuration
      - MQTT_HOST=${MQTT_HOST:-188.228.60.134}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USER=${MQTT_USER:-admin}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_CLIENT_ID=${MQTT_CLIENT_ID:-iocast-build-service}
      # GitHub Configuration
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO:-ufi-tech/iocast-android}
      # Build Configuration
      - BUILD_TIMEOUT=${BUILD_TIMEOUT:-1800}
      # CRITICAL: Must match config.py - use cimg/android:2024.01.1 with Java 17
      # mingc/android-build-box:latest has Java 21 which breaks builds!
      - DOCKER_IMAGE=${DOCKER_IMAGE:-cimg/android:2024.01.1}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default

networks:
  default:
    driver: bridge
